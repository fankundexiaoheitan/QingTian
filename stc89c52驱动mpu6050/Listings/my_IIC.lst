C51 COMPILER V9.54   MY_IIC                                                                09/25/2021 19:59:59 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MY_IIC
OBJECT MODULE PLACED IN .\Objects\my_IIC.obj
COMPILER INVOKED BY: C:\xuexigongju\keil\C51\BIN\C51.EXE my_IIC.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Li
                    -stings\my_IIC.lst) TABS(2) OBJECT(.\Objects\my_IIC.obj)

line level    source

   1          #include "my_IIC.h"
   2          #include "INTRINS.h"
   3          //***************************
   4          //延时5us
   5          //***************************
   6          void Delay5us(void)
   7          {
   8   1        _nop_();
   9   1        _nop_();
  10   1        _nop_();
  11   1        _nop_();
  12   1        _nop_();
  13   1      }
  14          
  15          
  16          //*************************************************************************************************
  17          //I2C起始信号
  18          //*************************************************************************************************
  19          void I2C_Start()
  20          {
  21   1          SDA = 1;                    //拉高数据线
  22   1          SCL = 1;                    //拉高时钟线
  23   1          Delay5us();                 //延时
  24   1          SDA = 0;                    //产生下降沿
  25   1          Delay5us();                 //延时
  26   1          SCL = 0;                    //拉低时钟线
  27   1      }
  28          //*************************************************************************************************
  29          //I2C停止信号
  30          //*************************************************************************************************
  31          void I2C_Stop()
  32          {
  33   1          SDA = 0;                    //拉低数据线
  34   1          SCL = 1;                    //拉高时钟线
  35   1          Delay5us();                 //延时
  36   1          SDA = 1;                    //产生上升沿
  37   1          Delay5us();                 //延时
  38   1      }
  39          //**************************************************************************************************
  40          //I2C发送应答信号
  41          //入口参数:ack (0:ACK 1:NAK)
  42          //**************************************************************************************************
  43          void I2C_SendACK(bit ack)
  44          {
  45   1          SDA = ack;                  //写应答信号
  46   1          SCL = 1;                    //拉高时钟线
  47   1          Delay5us();                 //延时
  48   1          SCL = 0;                    //拉低时钟线
  49   1          Delay5us();                 //延时
  50   1      }
  51          //****************************************************************************************************
  52          //I2C接收应答信号
  53          //****************************************************************************************************
  54          bit I2C_RecvACK()
C51 COMPILER V9.54   MY_IIC                                                                09/25/2021 19:59:59 PAGE 2   

  55          {
  56   1          SCL = 1;                    //拉高时钟线
  57   1          Delay5us();                 //延时
  58   1          CY = SDA;                   //读应答信号
  59   1          SCL = 0;                    //拉低时钟线
  60   1          Delay5us();                 //延时
  61   1          return CY;
  62   1      }
  63          //*****************************************************************************************************
  64          //向I2C总线发送一个字节数据
  65          //*****************************************************************************************************
  66          void I2C_SendByte(uchar dat)
  67          {
  68   1          uchar i;
  69   1          for (i=0; i<8; i++)         //8位计数器
  70   1          {
  71   2              dat <<= 1;              //移出数据的最高位
  72   2              SDA = CY;               //送数据口
  73   2              SCL = 1;                //拉高时钟线
  74   2              Delay5us();             //延时
  75   2              SCL = 0;                //拉低时钟线
  76   2              Delay5us();             //延时
  77   2          }
  78   1          I2C_RecvACK();
  79   1      }
  80          //*****************************************************************************************************
  81          //从I2C总线接收一个字节数据
  82          //******************************************************************************************************
  83          uchar I2C_RecvByte()
  84          {
  85   1          uchar i;
  86   1          uchar dat = 0;
  87   1          SDA = 1;                    //使能内部上拉,准备读取数据,
  88   1          for (i=0; i<8; i++)         //8位计数器
  89   1          {
  90   2              dat <<= 1;
  91   2              SCL = 1;                //拉高时钟线
  92   2              Delay5us();             //延时
  93   2              dat |= SDA;             //读数据               
  94   2              SCL = 0;                //拉低时钟线
  95   2              Delay5us();             //延时
  96   2          }
  97   1          return dat;
  98   1      }
  99          //*****************************************************************************************************
 100          //向I2C设备写入一个字节数据
 101          //*****************************************************************************************************
 102          void Single_WriteI2C(uchar PC_Address,uchar REG_Address,uchar REG_data)
 103          {
 104   1          I2C_Start();                  //起始信号
 105   1          I2C_SendByte(PC_Address);   //发送设备地址+写信号
 106   1          I2C_SendByte(REG_Address);    //内部寄存器地址，
 107   1          I2C_SendByte(REG_data);       //内部寄存器数据，
 108   1          I2C_Stop();                   //发送停止信号
 109   1      }
 110          //*******************************************************************************************************
 111          //从I2C设备读取一个字节数据
 112          //*******************************************************************************************************
 113          uchar Single_ReadI2C(uchar PC_Address,uchar REG_Address)
 114          {
 115   1        uchar REG_data;
 116   1        I2C_Start();                   //起始信号
C51 COMPILER V9.54   MY_IIC                                                                09/25/2021 19:59:59 PAGE 3   

 117   1        I2C_SendByte(PC_Address);    //发送设备地址+写信号
 118   1        I2C_SendByte(REG_Address);     //发送存储单元地址，从0开始  
 119   1        I2C_Start();                   //起始信号
 120   1        I2C_SendByte(PC_Address+1);  //发送设备地址+读信号
 121   1        REG_data=I2C_RecvByte();       //读出寄存器数据
 122   1        I2C_SendACK(1);                //接收应答信号
 123   1        I2C_Stop();                    //停止信号
 124   1        return REG_data;
 125   1      }
 126          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    164    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
